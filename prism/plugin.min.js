tinymce.PluginManager.requireLangPack("prism"),tinymce.PluginManager.add("prism",function(e){function t(){var t,a,n,i,r,l,o=e.dom,g=e.selection,c={},d={},s="markup",m="",u=g.getNode();if("code"==u.nodeName.toLowerCase()){var p=$(u).unwrap().text();p=p.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\n{2}/g,"<p>").replace(/\n/g,"<br>").replace(/ /g,"&nbsp;").replace(/\t/g,"　　　　"),g.setContent(p),u.remove()}else{d.linenumber=!0,d.firstline="",d.highlight="",c.language="",c.firstline=d.firstline,c.linenumber=d.linenumber,c.highlight=d.highlight;var h=e.settings.prism_languages,b=[{text:"HTML/XML",value:"markup"},{text:"CSS",value:"css"},{text:"C-like",value:"clike"},{text:"JavaScript",value:"javascript"}],v=h?h:b;l=g.getContent({format:"text"});for(var f=0;f<v.length;f++)v[f].value==c.language&&(v[f].selected=!0);c.code=l,""==c.code&&(m="<br>"),"&nbsp;"==c.code&&(c.code=""),t=e.windowManager.open({title:"Prism - Code Editor",data:c,minWidth:450,body:[{name:"language",type:"listbox",values:v},{name:"code",type:"textbox",minHeight:200,multiline:!0},{type:"form",padding:0,labelGap:5,spacing:5,align:"center",direction:"row",items:[{name:"linenumber",type:"checkbox",text:"Line Number",checked:c.linenumber},{name:"firstline",type:"textbox",label:"First Line",size:3,value:c.firstline},{name:"highlight",type:"textbox",label:"Highlight",size:10,value:c.highlight}]}],onsubmit:function(t){if(""===t.data.code)return void tinyMCE.activeEditor.windowManager.alert("Please insert your code.");var l=t.data.code;l=l.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/　{4}/g,"	");var g=t.data.language?t.data.language:s,c=t.data.firstline?t.data.firstline:"",d=t.data.linenumber?t.data.linenumber:!1,u=t.data.highlight?t.data.highlight:"";a=o.create("code",{"class":"language-"+g},l),d&&(n=' class="line-numbers"'),""!=c&&(i=' data-start="'+c+'"'),""!=u&&(r=' data-line="'+u+'"'),void 0===n?e.insertContent("<pre>"+o.getOuterHTML(a)+"</pre>"+m):e.insertContent("<pre"+n+i+r+">"+o.getOuterHTML(a)+"</pre>"+m)}})}}e.addButton("prism",{icon:"codesample",tooltip:"Insert code with Prism",onPostRender:function(){var t=this;e.on("NodeChange",function(e){var a=e.element.parentNode;t.active("code"==e.element.nodeName.toLowerCase()&&"pre"==a.tagName.toLowerCase())})},onclick:t}),e.addMenuItem("prism",{text:"Prism",icon:"codesample",context:"insert",onclick:t})});